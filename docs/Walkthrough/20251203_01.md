## 実装内容まとめ

### 1. 評価時のアブレーション機能 (Fast-only / Slow-only)

**変更ファイル:** inc_net.py, sema_components.py

#### 概要
Nested LoRA の fast ブランチと slow ブランチを、**評価時（推論時）のみ**個別にゼロ化できる機能を追加。

#### 仕組み
- **`nested_lora_eval_ablation`** というコンフィグフラグを追加（デフォルト: `"none"`）
- `NestedLoRAAdapter.forward()` 内で、`model.eval()` 時に以下の動作を実現:
  - `"fast_only"`: slow の出力をゼロ化（fast のみ使用）
  - `"slow_only"`: fast の出力をゼロ化（slow のみ使用）
  - `"none"`: 両方の出力を使用（従来通り）
- **学習時（`model.train()`）は両ブランチが常にアクティブ**

```python
# backbone/sema_components.py - NestedLoRAAdapter.forward()
mode = getattr(self.config, "nested_lora_eval_ablation", "none")
if not self.training:
    if mode == "fast_only":
        slow_out = torch.zeros_like(slow_out)
    elif mode == "slow_only":
        fast_out = torch.zeros_like(fast_out)
```

---

### 2. 評価時のチェックポイントパス指定

**変更ファイル:** main.py, eval.py

#### 概要
評価実行時にモデルのチェックポイントパスを**明示的に指定する必要がある**仕組みを追加。

#### 仕組み
- main.py に `--checkpt_path` 引数を追加
- eval.py で `checkpt_path` が未指定の場合はエラーを発生
- `load_checkpoint()` ヘルパー関数が `{"model_state_dict": ...}` 形式と生の state_dict 両方に対応

```python
# main.py
parser.add_argument('--checkpt_path', type=str, default=None,
                    help='Path to model checkpoint for eval-only runs.')

# eval.py
if checkpt_path is None:
    raise ValueError("`checkpt_path` is required for eval runs...")
```

---

### 3. トレーニング時のチェックポイント自動保存

**変更ファイル:** nested_lora.py

#### 概要
各タスク終了時に自動でチェックポイントを保存する機能を追加。

#### 仕組み
- **保存タイミング:** 各タスク終了時（`after_task()`）
- **保存先:** `checkpoints/{prefix}_seed{seed}_task{task}.pth`
- **保存内容:**
  - `model_state_dict`: モデルの重み
  - `task`: タスク番号
  - `known_classes`, `total_classes`: クラス数情報
  - `args`: 設定情報

#### コンフィグオプション
| オプション | デフォルト | 説明 |
|------------|-----------|------|
| `"save_checkpoints"` | `true` | 保存の有効/無効 |
| `"checkpoint_dir"` | `"checkpoints"` | 保存先ディレクトリ |

---

### 使用方法まとめ

#### 再学習（チェックポイント生成）
```bash
conda run -n sema_env python main.py --config exps/nested_lora_alpha0.1.json
# → checkpoints/nested_lora_alpha0.1_seed1993_task9.pth が生成される
```

#### 評価（3パターンのアブレーション）
```bash
# 両方（通常）
conda run -n sema_env python main.py --config exps/nested_lora_alpha0.1.json \
    --eval True --checkpt_path checkpoints/nested_lora_alpha0.1_seed1993_task9.pth

# fast-only: configに "nested_lora_eval_ablation": "fast_only" を追加
# slow-only: configに "nested_lora_eval_ablation": "slow_only" を追加
```

#### Seed追加（再現性向上）
```json
{
  "seed": [1993, 1994]
}
```

---

### ファイル変更サマリ

| ファイル | 変更内容 |
|----------|----------|
| sema_components.py | eval時のfast/slowアブレーション分岐追加 |
| inc_net.py | `nested_lora_eval_ablation` をtuning_configに伝播 |
| main.py | `--checkpt_path` 引数追加 |
| eval.py | チェックポイントの必須化 + `load_checkpoint()` ヘルパー追加 |
| nested_lora.py | `after_task()` でのチェックポイント自動保存 |