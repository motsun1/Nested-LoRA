# Walkthrough - Step 1: PAM-lite Consolidation

I have implemented the "PAM-lite" consolidation strategy as requested in Step 1. This mechanism aims to align the "fast" adapter updates with the "slow" adapter before merging, specifically by suppressing updates that conflict in sign.

## Changes

### Backbone
#### [sema_block.py](file:///home/mitsui/Desktop/SEMA-CL/backbone/sema_block.py)
- Updated `consolidate_nested_lora` to support `nested_lora_consolidation_method="pam"`.
- Added logic to handle `fast_adapters` (list) correctly, ensuring compatibility with both Chain (single fast) and MoE (multiple fast) structures.
- Implemented PAM logic:
    - `mask = (p_slow * p_fast >= 0).float()`
    - `p_fast_aligned = p_fast * mask`
    - `p_slow += alpha * p_fast_aligned`

## Verification Results

### Automated Tests
I created a new unit test `tests/test_pam_consolidation.py` to verify the logic.

#### Test Case: PAM Logic
- **Setup**:
    - `slow`: `[1.0, 1.0, -1.0, -1.0]`
    - `fast`: `[0.5, -0.5, -0.5, 0.5]`
    - `alpha`: `1.0`
- **Expected Result**:
    - Case 0 (Same sign ++): `1.0 + 0.5 = 1.5`
    - Case 1 (Opposite sign +-): `1.0 + 0.0 = 1.0` (Masked)
    - Case 2 (Same sign --): `-1.0 + (-0.5) = -1.5`
    - Case 3 (Opposite sign -+): `-1.0 + 0.0 = -1.0` (Masked)
- **Actual Result**: Passed.

```bash
conda run -n sema_env python tests/test_pam_consolidation.py
```

## Experiments

I have prepared the configuration files and a script to run the Step 1 experiments (Chain x Task Arithmetic vs Chain x PAM-lite).

### Configurations
- **Baseline (Task Arithmetic)**: [step1_chain_ta_alpha0.1.json](file:///home/mitsui/Desktop/SEMA-CL/exps/step1_chain_ta_alpha0.1.json)
- **PAM-lite**: [step1_chain_pam_alpha0.1.json](file:///home/mitsui/Desktop/SEMA-CL/exps/step1_chain_pam_alpha0.1.json)

### How to Run
To run all Step 1 experiments sequentially:

```bash
./run_nested_lora_pam.sh
```

This script will execute the baseline experiment followed by the PAM-lite experiment.