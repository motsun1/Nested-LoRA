# Nested LoRA Implementation Walkthrough (Refactored)

## 現状サマリ
- Nested LoRA v0 を実装済み。fast/slow を足し合わせて利用し、slow の更新間隔を制御できる。
- 動作確認は CIFAR-100 の 1 タスク・1 エポックのデバッグ実行のみ。10 タスク以上の本番実験は未着手。
- v1（タスク境界での consolidation）は未実装。

## 主要な変更ポイント
- `backbone/sema_components.py`  
  - `NestedLoRAAdapter` を追加。`fast` と `slow` の `Adapter` を保持し、forward で和を返す。
- `backbone/sema_block.py`  
  - `AdapterModule` が `ffn_adapter_type == "nested_lora"` のときに `NestedLoRAAdapter` を組み込む。
- `models/sema.py`  
  - `update_optimizer_and_scheduler`: fast/slow/other で param group を分離し、それぞれ lr を設定。  
  - `_init_train`: `nested_lora_update_interval_slow` に基づいて slow の勾配更新頻度を間引く。
- `utils/inc_net.py`  
  - `nested_lora_rank` をチューニング設定に渡す。
- Config 追加  
  - `exps/nested_lora_cifar.json`, `exps/nested_lora_inr_10task.json`（CIFAR-100 / ImageNet-R 向け）。

## 動作確認ログ（デバッグ実行）
- 設定: `exps/debug_nested_lora.json`（CIFAR-100, init_cls=50, increment=50? 1 タスク相当, 1 epoch）
- 結果: Loss 0.862, Train Acc 76.14%, Test Acc 94.04
- ログ: `logs/sema/cifar224/0/50/debug_nested_lora_1993_pretrained_vit_b16_224_adapter.log`
- 備考: pretrained ViT 重みを HF から取得して動作確認済み。

## 未対応・改善したい点
- v1 consolidation → 追加済み（`nested_lora_use_consolidation`, `nested_lora_consolidation_alpha`）。挙動確認が未。
- fast/slow ノルムのログ → 追加済み（タスク境界前後で L2 ノルムを INFO 出力）。細粒度のステップログは未。
- 本番スケジュール（10 タスク以上）での評価未実施。既存 baselines との比較も未実施。
- config の既定値はデバッグ寄り（epoch や rank、init_cls）。本番用に見直しが必要。

## 次にやること（実装・検証の優先度）
1) 実験準備  
   - CIFAR-100 10 タスク（init_cls=10, increment=10）用の config を本番値に調整。  
   - ImageNet-R 10 タスクも同様に準備（`exps/nested_lora_inr_10task.json` の epoch など確認）。
2) ロギング強化  
   - optimizer の param group（lr/param count）を起動時にログ。  
   - fast/slow のパラメータノルムをタスク終了時に簡易ログ。  
   - slow 更新間隔が効いているかをステップ単位で簡易トレース（頻度低で OK）。
3) v1 オプション  
   - `SEMAModules.end_of_task_training()` に consolidation フックを追加し、`nested_lora_use_consolidation` と `alpha` で制御。  
   - fast のゼロリセットも忘れずに。
4) ベースライン比較  
   - 同パラメータ規模の `ffn_adapter_type="adaptmlp"` / `lora` と比較。rank/bottleneck を揃えるか、総パラメータを一致させる。

## 実験プラン（現状の想定）
- CIFAR-100 (224) 10 タスク: init_cls=10, inc=10, epoch 10–20 を目安。  
- ImageNet-R 10 タスク: init_cls=20, inc=20, epoch 20 付近から試行。  
- アブレーション:  
  - slow 更新間隔 `nested_lora_update_interval_slow` ∈ {1, 5, 10}  
  - rank ∈ {8, 16}; lr_fast/lr_slow の比率（例: 10x, 5x）  
  - v1 consolidation on/off, `alpha` ∈ {0.05, 0.1, 0.2}  
- 主要指標: 各タスク acc、平均 acc、forgetting、fast/slow ノルム推移。
